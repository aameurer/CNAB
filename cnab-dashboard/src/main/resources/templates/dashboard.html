<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>CNAB Analytics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card-stat { transition: transform 0.2s; }
        .card-stat:hover { transform: translateY(-5px); }
        .card-stat h5 { font-size: 0.9rem; margin-bottom: 0.2rem; }
        .card-stat h3 { font-size: 1.2rem; font-weight: bold; }
        .prefix-api { color: #0d6efd; font-weight: 500; }
        .prefix-geral { color: #198754; font-weight: 500; }
        .table-sm-custom { font-size: 10pt; }
        .table-sm-custom td, .table-sm-custom th { padding-top: 2px; padding-bottom: 2px; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="#">CNAB Analytics Pro</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link active" href="#">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/analise-datas">Análise de Prazos</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container">
    
    <!-- Alerts -->
    <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <!-- Date Filter -->
    <div class="card mb-4">
        <div class="card-body py-3">
            <form th:action="@{/}" method="get" class="row g-3 align-items-end">
                <input type="hidden" name="filter" th:value="${filter}" />
                <div class="col-md-3">
                    <label class="form-label small text-muted">Data Início</label>
                    <input type="date" class="form-control form-control-sm" name="startDate" th:value="${startDate}">
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted">Data Fim</label>
                    <input type="date" class="form-control form-control-sm" name="endDate" th:value="${endDate}">
                </div>
                <div class="col-md-2 d-flex align-items-center mb-1">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="useCreditDate" name="useCreditDate" th:checked="${useCreditDate}">
                        <label class="form-check-label small" for="useCreditDate">Por Data Crédito</label>
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary btn-sm w-100">Filtrar</button>
                </div>
                <div class="col-md-2">
                     <a href="/" class="btn btn-outline-secondary btn-sm w-100">Limpar</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="row mb-4 row-cols-1 row-cols-md-5 g-3">
        <div class="col">
            <div class="card card-stat text-white bg-primary h-100">
                <div class="card-body py-2">
                    <h5 class="card-title">Total API</h5>
                    <h3 class="card-text" th:text="${#numbers.formatCurrency(stats.totalApi ?: 0)}">R$ 0,00</h3>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card card-stat text-white bg-success h-100">
                <div class="card-body py-2">
                    <h5 class="card-title">Total Geral</h5>
                    <h3 class="card-text" th:text="${#numbers.formatCurrency(stats.totalGeral ?: 0)}">R$ 0,00</h3>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card card-stat text-white bg-secondary h-100" style="background-color: #6c757d !important;">
                <div class="card-body py-2">
                    <h5 class="card-title">Diferença</h5>
                    <h3 class="card-text" th:text="${#numbers.formatCurrency(stats.difference ?: 0)}">R$ 0,00</h3>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card card-stat text-white bg-warning h-100">
                <div class="card-body py-2">
                    <h5 class="card-title">Conciliados</h5>
                    <h3 class="card-text" th:text="${stats.countConciliados ?: 0}">0</h3>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card card-stat text-white bg-danger h-100">
                <div class="card-body py-2">
                    <h5 class="card-title">Divergências</h5>
                    <h3 class="card-text" th:text="${stats.countDivergencias ?: 0}">0</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts & Upload Row -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header">Distribuição de Valores</div>
                <div class="card-body">
                    <canvas id="mainChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header">Importação de Arquivos</div>
                <div class="card-body">
                    <form th:action="@{/upload}" method="post" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label class="form-label">Arquivos API (.RET)</label>
                            <input class="form-control" type="file" name="apiFiles" multiple accept=".RET">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Arquivos Geral (.RET)</label>
                            <input class="form-control" type="file" name="geralFiles" multiple accept=".RET">
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Processar & Conciliar</button>
                        </div>
                    </form>
                    <hr>
                    <form th:action="@{/clear}" method="post">
                        <div class="d-grid">
                            <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Tem certeza?')">Limpar Banco de Dados</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Detalhamento das Transações</span>
            <div>
                <a th:href="@{/analise-datas(onlyDivergences=true, startDate=${startDate}, endDate=${endDate}, useCreditDate=${useCreditDate})}" class="btn btn-sm btn-outline-danger me-2">Ver Divergências</a>
                <a th:href="@{/(startDate=${startDate}, endDate=${endDate}, useCreditDate=${useCreditDate})}" class="btn btn-sm btn-outline-secondary">Ver Tudo</a>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-striped table-sm-custom">
                    <thead>
                        <tr>
                            <th>Origem</th>
                            <th>Status</th>
                            <th>Nosso Número</th>
                            <th>Valor Pago</th>
                            <th>Data Ocorrência</th>
                            <th>Data Crédito</th>
                            <th>Pagador</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="t : ${transactions}">
                            <td>
                                <span th:if="${t.tipoOrigem == 'API'}" class="badge bg-primary">API</span>
                                <span th:if="${t.tipoOrigem == 'GERAL'}" class="badge bg-success">GERAL</span>
                            </td>
                            <td>
                                <span th:if="${t.statusConciliacao == 'CONCILIADO'}" class="badge bg-success">OK</span>
                                <span th:if="${t.statusConciliacao == 'DIVERGENTE'}" class="badge bg-danger">DIVERGENTE</span>
                                <span th:if="${t.statusConciliacao == 'PENDENTE'}" class="badge bg-secondary">PENDENTE</span>
                            </td>
                            <td th:text="${t.nossoNumero}"></td>
                            <td th:text="${#numbers.formatCurrency(t.valorPago)}"></td>
                            <td th:text="${#temporals.format(t.dataOcorrencia, 'dd/MM/yyyy')}"></td>
                            <td th:text="${t.dataCredito != null ? #temporals.format(t.dataCredito, 'dd/MM/yyyy') : '-'}"></td>
                            <td th:text="${t.nomePagador}"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Simple Pagination -->
            <nav th:if="${transactions.totalPages > 1}">
                <ul class="pagination justify-content-center">
                    <li class="page-item" th:classappend="${transactions.first ? 'disabled' : ''}">
                        <a class="page-link" th:href="@{/(page=${transactions.number - 1}, filter=${filter}, startDate=${startDate}, endDate=${endDate})}">Anterior</a>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link" th:text="${'Página ' + (transactions.number + 1) + ' de ' + transactions.totalPages}"></span>
                    </li>
                    <li class="page-item" th:classappend="${transactions.last ? 'disabled' : ''}">
                        <a class="page-link" th:href="@{/(page=${transactions.number + 1}, filter=${filter}, startDate=${startDate}, endDate=${endDate})}">Próxima</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

</div>

<script th:inline="javascript">
    /* Chart.js Setup */
    const ctx = document.getElementById('mainChart').getContext('2d');
    const totalApi = [[${stats.totalApi ?: 0}]];
    const totalGeral = [[${stats.totalGeral ?: 0}]];
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Volume API', 'Volume Geral'],
            datasets: [{
                label: 'Valor Total (R$)',
                data: [totalApi, totalGeral],
                backgroundColor: [
                    'rgba(13, 110, 253, 0.7)',
                    'rgba(25, 135, 84, 0.7)'
                ],
                borderColor: [
                    'rgb(13, 110, 253)',
                    'rgb(25, 135, 84)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
</script>

</body>
</html>
