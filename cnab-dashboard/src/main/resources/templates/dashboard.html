<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<body>

    <div th:replace="~{layout :: layout(~{::section}, 'dashboard')}">
        <section th:fragment="content">
            <div class="container">

                <!-- Alerts -->
                <div th:if="${message}"
                    th:class="${'alert alert-' + (messageType ?: 'success') + ' alert-dismissible fade show'}"
                    role="alert">
                    <span th:text="${message}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <span th:text="${error}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <!-- Date Filter -->
                <div class="card mb-4">
                    <div class="card-body py-3">
                        <form th:action="@{/}" method="get" class="row g-3 align-items-end">
                            <input type="hidden" name="filter" th:value="${filter}" />
                            <div class="col-md-3">
                                <label class="form-label small text-muted">Data Início</label>
                                <input type="date" class="form-control form-control-sm" name="startDate"
                                    th:value="${startDate}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small text-muted">Data Fim</label>
                                <input type="date" class="form-control form-control-sm" name="endDate"
                                    th:value="${endDate}">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small text-muted">Considerar Data</label>
                                <select class="form-select form-select-sm" name="useCreditDate">
                                    <option value="false" th:selected="${useCreditDate == false}">Ocorrência</option>
                                    <option value="true" th:selected="${useCreditDate == true}">Crédito</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary btn-sm w-100">Filtrar</button>
                            </div>
                            <div class="col-md-2">
                                <a href="/" class="btn btn-outline-secondary btn-sm w-100">Limpar</a>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Stats Row -->
                <div class="row mb-4 row-cols-1 row-cols-md-5 g-3">
                    <div class="col">
                        <div class="card card-stat text-white bg-primary h-100">
                            <div class="card-body py-2">
                                <h5 class="card-title">Total API</h5>
                                <h3 class="card-text"
                                    th:text="${#numbers.formatCurrency(stats != null ? stats.totalApi : 0)}">R$ 0,00
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card card-stat text-white bg-success h-100">
                            <div class="card-body py-2">
                                <h5 class="card-title">Total Geral</h5>
                                <h3 class="card-text"
                                    th:text="${#numbers.formatCurrency(stats != null ? stats.totalGeral : 0)}">R$ 0,00
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card card-stat text-white bg-secondary h-100"
                            style="background-color: #6c757d !important;">
                            <div class="card-body py-2">
                                <h5 class="card-title">Diferença</h5>
                                <h3 class="card-text"
                                    th:text="${#numbers.formatCurrency(stats != null ? stats.difference : 0)}">R$ 0,00
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card card-stat text-white bg-warning h-100">
                            <div class="card-body py-2">
                                <h5 class="card-title">Conciliados</h5>
                                <h3 class="card-text" th:text="${stats != null ? stats.countConciliados : 0}">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card card-stat text-white bg-danger h-100">
                            <div class="card-body py-2">
                                <h5 class="card-title">Divergências</h5>
                                <h3 class="card-text" th:text="${stats != null ? stats.countDivergencias : 0}">0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">Volume de Transações</div>
                            <div class="card-body">
                                <canvas id="mainChart" style="max-height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">Distribuição Financeira</div>
                            <div class="card-body">
                                <canvas id="financialChart" style="max-height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Detalhamento das Transações</span>
                        <div>
                            <a th:href="@{/analise-datas(onlyDivergences=true, startDate=${startDate}, endDate=${endDate}, useCreditDate=${useCreditDate})}"
                                class="btn btn-sm btn-outline-danger me-2">
                                Ver Divergências <span class="badge bg-danger text-white ms-1"
                                    th:text="${stats.countDivergencias ?: 0}">0</span>
                            </a>
                            <a th:href="@{/(startDate=${startDate}, endDate=${endDate}, useCreditDate=${useCreditDate})}"
                                th:class="${filter == null || filter == '' ? 'btn btn-sm btn-secondary' : 'btn btn-sm btn-outline-secondary'}">
                                Ver Tudo
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped table-sm-custom">
                                <thead>
                                    <tr>
                                        <th>Origem</th>
                                        <th>Status</th>
                                        <th>Nosso Número</th>
                                        <th>Valor Pago</th>
                                        <th>Data Ocorrência</th>
                                        <th>Data Crédito</th>
                                        <th>Pagador</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="t : ${transactions}">
                                        <td>
                                            <span th:if="${t.tipoOrigem.name() == 'API'}"
                                                class="badge bg-primary">API</span>
                                            <span th:if="${t.tipoOrigem.name() == 'GERAL'}"
                                                class="badge bg-success">GERAL</span>
                                        </td>
                                        <td>
                                            <span th:if="${t.statusConciliacao == 'CONCILIADO'}"
                                                class="badge bg-success">OK</span>
                                            <span th:if="${t.statusConciliacao == 'DIVERGENTE'}"
                                                class="badge bg-danger">DIVERGENTE</span>
                                            <span th:if="${t.statusConciliacao == 'PENDENTE'}"
                                                class="badge bg-warning text-dark">PENDENTE</span>
                                        </td>
                                        <td th:text="${t.nossoNumero}"></td>
                                        <td th:text="${#numbers.formatCurrency(t.valorPago)}"></td>
                                        <td th:text="${#temporals.format(t.dataOcorrencia, 'dd/MM/yyyy')}"></td>
                                        <td
                                            th:text="${t.dataCredito != null ? #temporals.format(t.dataCredito, 'dd/MM/yyyy') : '-'}">
                                        </td>
                                        <td>
                                            <a href="#" th:attr="hx-get=@{/transacao/{id}(id=${t.id})}"
                                                hx-target="#transactionModalContent" data-bs-toggle="modal"
                                                data-bs-target="#transactionModal" th:text="${t.nomePagador}"
                                                style="text-decoration: none; font-weight: bold;">
                                            </a>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Simple Pagination -->
                        <nav th:if="${transactions.totalPages > 1}">
                            <ul class="pagination justify-content-center">
                                <li class="page-item" th:classappend="${transactions.first ? 'disabled' : ''}">
                                    <a class="page-link"
                                        th:href="@{/(page=${transactions.number - 1}, filter=${filter}, startDate=${startDate}, endDate=${endDate})}">Anterior</a>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link"
                                        th:text="${'Página ' + (transactions.number + 1) + ' de ' + transactions.totalPages}"></span>
                                </li>
                                <li class="page-item" th:classappend="${transactions.last ? 'disabled' : ''}">
                                    <a class="page-link"
                                        th:href="@{/(page=${transactions.number + 1}, filter=${filter}, startDate=${startDate}, endDate=${endDate})}">Próxima</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>

            </div>

            <script th:inline="javascript">
                (function () {
                    /* Chart.js Setup */
                    const canvasMain = document.getElementById('mainChart');
                    if (canvasMain) {
                        const existingChart = Chart.getChart(canvasMain);
                        if (existingChart) existingChart.destroy();

                        const ctx = canvasMain.getContext('2d');
                        const totalApi = [[${ stats != null ? stats.totalApi : 0}]];
                    const totalGeral = [[${ stats != null ? stats.totalGeral : 0}]];

                if (ctx) {
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Volume API', 'Volume Geral'],
                            datasets: [{
                                label: 'Valor Total (R$)',
                                data: [totalApi, totalGeral],
                                backgroundColor: [
                                    'rgba(13, 110, 253, 0.7)',
                                    'rgba(25, 135, 84, 0.7)'
                                ],
                                borderColor: [
                                    'rgb(13, 110, 253)',
                                    'rgb(25, 135, 84)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }
                }

                /* Financial Chart Setup */
                const canvasFin = document.getElementById('financialChart');
                if (canvasFin) {
                    const existingChartFin = Chart.getChart(canvasFin);
                    if (existingChartFin) existingChartFin.destroy();

                    const ctxFin = canvasFin.getContext('2d');
                    if (ctxFin) {
                        const finLabels = [];
                        const finData = [];

                        /*[# th:each="entry : ${stats != null ? stats.financialDistribution : {}}"]*/
                        finLabels.push(/*[[${entry.key}]]*/ 'Label');
                        finData.push(/*[[${entry.value}]]*/ 0);
                        /*[/]*/

                        new Chart(ctxFin, {
                            type: 'pie',
                            data: {
                                labels: finLabels,
                                datasets: [{
                                    data: finData,
                                    backgroundColor: [
                                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                                        '#FF9F40', '#E7E9ED', '#76A346', '#F05B4F', '#3266CC'
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'right',
                                        labels: {
                                            generateLabels: function (chart) {
                                                const data = chart.data;
                                                if (data.labels.length && data.datasets.length) {
                                                    return data.labels.map((label, i) => {
                                                        const ds = data.datasets[0];
                                                        const value = ds.data[i];
                                                        const fillStyle = ds.backgroundColor[i];
                                                        const formattedValue = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);

                                                        return {
                                                            text: `${label}: ${formattedValue}`,
                                                            fillStyle: fillStyle,
                                                            strokeStyle: fillStyle,
                                                            lineWidth: 0,
                                                            hidden: chart.getDatasetMeta(0).data[i].hidden,
                                                            index: i
                                                        };
                                                    });
                                                }
                                                return [];
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                }
            }) ();
            </script>
        </section>
    </div>

</body>

</html>