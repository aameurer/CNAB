<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<body>

    <div th:replace="~{layout :: layout(~{::section}, 'import')}">
        <section th:fragment="content">
            <div class="container">
                <h2 class="mb-4">Importação de Arquivos</h2>

                <!-- Alerts -->
                <div th:if="${message}"
                    th:class="${'alert alert-' + (messageType ?: 'success') + ' alert-dismissible fade show'}"
                    role="alert">
                    <span th:text="${message}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <span th:text="${error}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <div class="row justify-content-center">
                    <div class="col-md-10">
                        <div class="card shadow-sm">
                            <div class="card-header bg-primary text-white d-flex align-items-center">
                                <i class="bi bi-cloud-upload fs-4 me-2"></i>
                                <h5 class="mb-0">Nova Importação</h5>
                            </div>
                            <div class="card-body">
                                <form th:action="@{/upload}" method="post" enctype="multipart/form-data"
                                    id="importForm">

                                    <div class="row mb-4">
                                        <div class="col-md-6 border-end">
                                            <label class="form-label fw-bold text-primary"><i
                                                    class="bi bi-file-earmark-code"></i> Arquivos API (.RET)</label>
                                            <div class="input-group mb-2">
                                                <input class="form-control" type="file" name="apiFiles"
                                                    id="apiFilesInput" multiple accept=".RET"
                                                    onchange="updateFileList('apiFilesInput', 'apiList')">
                                            </div>
                                            <div class="form-text text-muted mb-2">Selecione arquivos de retorno da API.
                                            </div>
                                            <ul id="apiList" class="list-group list-group-flush small"
                                                style="max-height: 200px; overflow-y: auto;"></ul>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold text-success"><i
                                                    class="bi bi-file-earmark-spreadsheet"></i> Arquivos Geral
                                                (.RET)</label>
                                            <div class="input-group mb-2">
                                                <input class="form-control" type="file" name="geralFiles"
                                                    id="geralFilesInput" multiple accept=".RET"
                                                    onchange="updateFileList('geralFilesInput', 'geralList')">
                                            </div>
                                            <div class="form-text text-muted mb-2">Selecione arquivos de retorno Geral.
                                            </div>
                                            <ul id="geralList" class="list-group list-group-flush small"
                                                style="max-height: 200px; overflow-y: auto;"></ul>
                                        </div>
                                    </div>

                                    <div class="alert alert-light border mb-4">
                                        <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-gear"></i> Configurações da
                                            Importação</h6>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="checkDuplicates" checked
                                                disabled>
                                            <label class="form-check-label" for="checkDuplicates">
                                                Verificar duplicidade de arquivos
                                                <span class="badge bg-success ms-2">Ativo</span>
                                            </label>
                                            <div class="form-text">O sistema impedirá automaticamente a importação de
                                                arquivos já processados para garantir a integridade dos dados.</div>
                                        </div>
                                    </div>

                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-primary btn-lg" id="btnSubmit">
                                            <span id="btnText"><i class="bi bi-play-circle"></i> Iniciar Processamento e
                                                Conciliação</span>
                                            <div id="btnSpinner" class="spinner-border spinner-border-sm d-none"
                                                role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <script>
                function updateFileList(inputId, listId) {
                    const input = document.getElementById(inputId);
                    const list = document.getElementById(listId);
                    list.innerHTML = '';

                    if (input.files.length > 0) {
                        for (let i = 0; i < input.files.length; i++) {
                            const file = input.files[i];
                            const li = document.createElement('li');
                            li.className = 'list-group-item d-flex justify-content-between align-items-center py-1 px-2 bg-light mb-1 rounded';

                            let size = file.size;
                            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                            if (size == 0) size = '0 Byte';
                            else {
                                const i = parseInt(Math.floor(Math.log(size) / Math.log(1024)));
                                size = Math.round(size / Math.pow(1024, i), 2) + ' ' + sizes[i];
                            }

                            li.innerHTML = `
                            <div class="d-flex align-items-center text-truncate">
                                <i class="bi bi-file-text me-2 text-secondary"></i>
                                <span class="text-truncate" title="${file.name}">${file.name}</span>
                            </div>
                            <span class="badge bg-secondary rounded-pill ms-2">${size}</span>
                        `;
                            list.appendChild(li);
                        }
                    }
                }

                document.getElementById('importForm').addEventListener('submit', function () {
                    const btn = document.getElementById('btnSubmit');
                    const btnText = document.getElementById('btnText');
                    const btnSpinner = document.getElementById('btnSpinner');

                    // Check if any file is selected
                    const apiFiles = document.getElementById('apiFilesInput').files.length;
                    const geralFiles = document.getElementById('geralFilesInput').files.length;

                    if (apiFiles === 0 && geralFiles === 0) {
                        // Let the backend handle empty submission or show alert
                        // But showing spinner is fine
                    }

                    btn.classList.add('disabled');
                    btnText.textContent = 'Processando...';
                    btnSpinner.classList.remove('d-none');
                });
            </script>
        </section>
    </div>

</body>

</html>