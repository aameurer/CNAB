<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

<div th:replace="~{layout :: layout(~{::section}, 'files')}">
    <section>
        <div class="container">
            <h2 class="mb-4">Gerenciar Arquivos do Banco de Dados</h2>

            <div th:if="${message}" th:class="${'alert alert-' + (messageType ?: 'info') + ' alert-dismissible fade show'}" role="alert">
                <span th:text="${message}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <i class="bi bi-exclamation-triangle-fill"></i> Atenção: A exclusão de arquivos removerá permanentemente todos os registros associados.
                </div>
                <div class="card-body">
                    <form action="/files/delete" method="post" id="deleteForm">
                        <div class="mb-3">
                            <label for="fileSelect" class="form-label">Selecione os arquivos para excluir (Segure Ctrl para selecionar múltiplos):</label>
                            <select class="form-select" id="fileSelect" name="selectedFiles" multiple size="15" required>
                                <option th:each="file : ${files}" th:value="${file}" th:text="${file}"></option>
                            </select>
                            <div th:if="${#lists.isEmpty(files)}" class="form-text text-muted">
                                Nenhum arquivo encontrado no banco de dados.
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-secondary" onclick="selectAll()">Selecionar Todos</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="deselectAll()">Limpar Seleção</button>
                            <button type="button" class="btn btn-danger ms-auto" onclick="openDeleteModal()">
                                Excluir Selecionados
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal de Confirmação -->
        <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar Exclusão</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p id="deleteMessage">Tem certeza que deseja excluir os arquivos selecionados?</p>
                        <p class="text-danger small mb-0"><i class="bi bi-exclamation-triangle"></i> Esta ação não pode ser desfeita.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-danger" onclick="submitDeleteForm()">Confirmar Exclusão</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function selectAll() {
                const select = document.getElementById('fileSelect');
                for (let i = 0; i < select.options.length; i++) {
                    select.options[i].selected = true;
                }
            }

            function deselectAll() {
                const select = document.getElementById('fileSelect');
                for (let i = 0; i < select.options.length; i++) {
                    select.options[i].selected = false;
                }
            }

            function openDeleteModal() {
                const select = document.getElementById('fileSelect');
                const selectedCount = Array.from(select.options).filter(opt => opt.selected).length;

                if (selectedCount === 0) {
                    alert('Por favor, selecione pelo menos um arquivo para excluir.');
                    return;
                }

                const message = `Tem certeza que deseja excluir ${selectedCount} arquivo(s) e todos os seus registros associados?`;
                document.getElementById('deleteMessage').textContent = message;

                const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
                modal.show();
            }

            function submitDeleteForm() {
                document.getElementById('deleteForm').submit();
            }
        </script>
    </section>
</div>

</body>
</html>
